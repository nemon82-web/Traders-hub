<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Notes - Transcendent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/base16/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1C2526;
            --secondary: #00FFF5;
            --accent: #FF00E4;
            --text: #F0F6FF;
            --bg: #0A0E14;
            --glow: 0 0 12px rgba(0, 255, 245, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            background: linear-gradient(145deg, var(--bg), #1C2526);
            color: var(--text);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 2rem;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        body.cosmic::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: stars 100s linear infinite;
            z-index: -1;
        }

        .sidebar {
            background: var(--primary);
            border-radius: 20px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            box-shadow: var(--glow);
            transform: translateX(0);
            z-index: 100;
        }

        .notes-list {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) transparent;
        }

        .note-item {
            padding: 1.2rem;
            border-radius: 12px;
            cursor: pointer;
            margin: 0.6rem 0;
            background: rgba(255, 255, 255, 0.08);
            animation: flipIn 0.5s ease-out;
            position: relative;
            transform-style: preserve-3d;
        }

        .note-item:hover {
            transform: scale(1.05) rotateY(5deg);
            box-shadow: var(--glow);
        }

        .note-item.pinned::before {
            content: 'ðŸŒŸ';
            position: absolute;
            left: 0.8rem;
            top: 0.8rem;
        }

        .editor-container {
            background: var(--primary);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--glow);
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 2rem;
            position: relative;
        }

        .editor-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 255, 245, 0.1), transparent);
            opacity: 0.3;
            z-index: -1;
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--secondary), var(--accent));
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: scale(1.08);
            filter: brightness(1.2);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn:active::after {
            width: 200px;
            height: 200px;
        }

        .save-btn {
            background: var(--accent) !important;
        }

        textarea {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: var(--text);
            padding: 1.5rem;
            resize: none;
            font-size: 1.2rem;
            line-height: 1.7;
            width: 100%;
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
        }

        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 4px var(--secondary);
        }

        .preview {
            padding: 1.5rem;
            overflow-y: auto;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            padding-top: 1.5rem;
        }

        .active-note {
            background: linear-gradient(45deg, var(--secondary), var(--accent)) !important;
            box-shadow: var(--glow);
        }

        .view-toggle {
            display: flex;
            gap: 0.6rem;
        }

        .toggle-btn {
            background: rgba(255, 255, 255, 0.15) !important;
        }

        .toggle-btn.active {
            background: var(--secondary) !important;
        }

        .tags {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.6rem;
        }

        .tag {
            background: var(--accent);
            color: var(--text);
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--primary);
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 700px;
            box-shadow: var(--glow);
            position: relative;
        }

        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem;
        }

        .kanban-column {
            flex: 0 0 250px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
        }

        .split-view {
            display: flex !important;
            gap: 1.5rem;
        }

        .split-view #editor,
        .split-view #preview {
            width: 50%;
            height: 100%;
        }

        .ai-suggestion {
            background: rgba(0, 255, 245, 0.2);
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            .sidebar {
                position: fixed;
                left: -100%;
                width: 100%;
                height: 100%;
                transition: left 0.4s ease;
            }
            .sidebar.visible {
                left: 0;
            }
            .split-view {
                flex-direction: column;
            }
            .split-view #editor,
            .split-view #preview {
                width: 100%;
                height: 50%;
            }
        }

        @keyframes flipIn {
            from {
                transform: rotateY(-90deg);
                opacity: 0;
            }
            to {
                transform: rotateY(0);
                opacity: 1;
            }
        }

        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="btn close-btn" onclick="toggleSidebar()" title="Close sidebar"><i class="fas fa-times"></i></button>
        <div class="toolbar">
            <button class="btn" onclick="createNewNote()" title="New note"><i class="fas fa-plus"></i> New</button>
            <select id="themeSelect" class="btn" onchange="changeTheme(this.value)" title="Change theme">
                <option value="cyberpunk">Cyberpunk</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="cosmic">Cosmic</option>
            </select>
            <button class="btn" onclick="showTemplates()" title="Note templates"><i class="fas fa-file-alt"></i></button>
        </div>
        <input type="text" id="searchInput" placeholder="Search notes..." class="btn" style="background: none; width: 100%;">
        <input type="text" id="tagFilter" placeholder="Filter by tag..." class="btn" style="background: none; width: 100%;">
        <div class="notes-list" id="notesList"></div>
        <div class="status-bar">
            <span id="noteCount">0 notes</span>
            <button class="btn" onclick="showKanban()" title="Kanban view"><i class="fas fa-th"></i></button>
            <button class="btn" onclick="showProfile()" title="Profile"><i class="fas fa-user"></i></button>
        </div>
    </div>

    <div class="editor-container">
        <div class="toolbar">
            <button class="btn" onclick="toggleSidebar()" title="Show notes"><i class="fas fa-book"></i></button>
            <input type="text" id="noteTitle" placeholder="Note title..." class="btn" style="background: none; flex-grow: 1;">
            <input type="text" id="noteTags" placeholder="Tags (comma separated)" class="btn" style="background: none; width: 100%; margin-top: 0.5rem;">
            <div class="rich-text-toolbar" style="display: flex; gap: 0.6rem; margin-top: 0.5rem;">
                <button class="btn" onclick="formatText('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                <button class="btn" onclick="formatText('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                <button class="btn" onclick="formatText('list')" title="List"><i class="fas fa-list"></i></button>
                <button class="btn" onclick="formatText('heading')" title="Heading"><i class="fas fa-heading"></i></button>
            </div>
            <div class="view-toggle">
                <button class="btn toggle-btn active" onclick="toggleView('editor')" title="Edit"><i class="fas fa-pen"></i></button>
                <button class="btn toggle-btn" onclick="toggleView('preview')" title="Preview"><i class="fas fa-eye"></i></button>
                <button class="btn toggle-btn" onclick="toggleView('split')" title="Split view"><i class="fas fa-columns"></i></button>
            </div>
            <button class="btn save-btn" onclick="saveNote()" title="Save"><i class="fas fa-save"></i></button>
            <button class="btn" onclick="deleteNote()" title="Delete"><i class="fas fa-trash"></i></button>
            <button class="btn" onclick="exportNote()" title="Export"><i class="fas fa-file-export"></i></button>
            <button class="btn" onclick="shareNote()" title="Share"><i class="fas fa-share"></i></button>
            <button class="btn" onclick="pinNote()" title="Pin note"><i class="fas fa-thumbtack"></i></button>
            <button class="btn" onclick="recordAudio()" title="Record audio"><i class="fas fa-microphone"></i></button>
            <button class="btn" onclick="showVersionHistory()" title="Version history"><i class="fas fa-history"></i></button>
            <button class="btn" onclick="presentNote()" title="Present"><i class="fas fa-play"></i></button>
        </div>
        <textarea id="editor" placeholder="Start writing in Markdown..."></textarea>
        <div class="preview" id="preview" style="display: none;"></div>
        <div id="aiSuggestions" class="ai-suggestion" style="display: none;"></div>
        <div class="status-bar">
            <span id="wordCount">0 words</span>
            <span id="lastSaved">Never saved</span>
            <span id="syncStatus"></span>
            <span id="collaborators"></span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        marked.setOptions({
            highlight: (code, lang) => hljs.highlightAuto(code).value,
            breaks: true
        });

        let notes = JSON.parse(localStorage.getItem('notes') || '[]');
        let currentNoteId = null;
        let history = [];
        let historyIndex = -1;
        let socket = null;
        let badges = JSON.parse(localStorage.getItem('badges') || '[]');
        let kanban = { todo: [], inProgress: [], done: [] };

        const themes = {
            cyberpunk: {
                primary: '#1C2526',
                secondary: '#00FFF5',
                accent: '#FF00E4',
                bg: '#0A0E14',
                text: '#F0F6FF'
            },
            dark: {
                primary: '#2A2F3B',
                secondary: '#3B82F6',
                bg: '#1E293B',
                text: '#F8FAFC'
            },
            light: {
                primary: '#FFFFFF',
                secondary: '#2563EB',
                bg: '#F1F5F9',
                text: '#1E293B'
            },
            cosmic: {
                primary: '#1A1B2E',
                secondary: '#7B68EE',
                accent: '#FFD700',
                bg: '#0B0C1C',
                text: '#E6E6FA'
            }
        };

        function changeTheme(theme) {
            const selectedTheme = themes[theme];
            Object.entries(selectedTheme).forEach(([key, value]) => {
                document.body.style.setProperty(`--${key}`, value);
            });
            document.body.className = theme === 'cosmic' ? 'cosmic' : '';
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('visible');
        }

        function toggleView(view) {
            const editorContainer = document.querySelector('.editor-container');
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview');
            const buttons = document.querySelectorAll('.toggle-btn');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            editorContainer.classList.remove('split-view');
            
            if (view === 'editor') {
                editor.style.display = 'block';
                preview.style.display = 'none';
                document.querySelector(`[onclick="toggleView('editor')"]`).classList.add('active');
            } else if (view === 'preview') {
                editor.style.display = 'none';
                preview.style.display = 'block';
                preview.innerHTML = marked.parse(editor.value);
                document.querySelector(`[onclick="toggleView('preview')"]`).classList.add('active');
            } else {
                editor.style.display = 'block';
                preview.style.display = 'block';
                preview.innerHTML = marked.parse(editor.value);
                document.querySelector(`[onclick="toggleView('split')"]`).classList.add('active');
                editorContainer.classList.add('split-view');
            }
        }

        function createNewNote(template = null) {
            const note = {
                id: Date.now(),
                title: 'Untitled Note',
                content: template || '',
                tags: [],
                pinned: false,
                versions: [],
                created: new Date().toISOString(),
                updated: new Date().toISOString(),
                kanbanStatus: 'todo'
            };
            notes.push(note);
            kanban.todo.push(note.id);
            saveNotes();
            renderNotes();
            selectNote(note.id);
            checkBadges();
            addToHistory(note.id);
        }

        function deleteNote() {
            if (!currentNoteId) return;
            notes = notes.filter(note => note.id !== currentNoteId);
            for (let status in kanban) {
                kanban[status] = kanban[status].filter(id => id !== currentNoteId);
            }
            saveNotes();
            renderNotes();
            currentNoteId = null;
            clearEditor();
        }

        function pinNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            note.pinned = !note.pinned;
            saveNotes();
            renderNotes();
        }

        function selectNote(id) {
            currentNoteId = id;
            const note = notes.find(n => n.id === id);
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('editor').value = note.content;
            document.getElementById('noteTags').value = note.tags.join(', ');
            updatePreview();
            updateActiveNoteStyle(id);
            toggleView('editor');
            updateAISuggestions(note.content);
            addToHistory(id);
        }

        function updatePreview() {
            const content = document.getElementById('editor').value;
            document.getElementById('preview').innerHTML = marked.parse(content);
            updateWordCount(content);
            updateAISuggestions(content);
        }

        function updateWordCount(text) {
            const words = text.trim().split(/\s+/).filter(w => w).length;
            document.getElementById('wordCount').textContent = 
                `${words} words â€¢ ${text.length} chars`;
            checkBadges();
        }

        function saveNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            note.title = document.getElementById('noteTitle').value;
            note.content = document.getElementById('editor').value;
            note.tags = document.getElementById('noteTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            note.updated = new Date().toISOString();
            note.versions.push({
                timestamp: note.updated,
                content: note.content,
                title: note.title
            });
            saveNotes();
            document.getElementById('lastSaved').textContent = 
                `Last saved: ${new Date().toLocaleTimeString()}`;
            renderNotes();
            addToHistory(currentNoteId);
            if (socket) socket.send(JSON.stringify({ id: currentNoteId, content: note.content }));
        }

        function saveNotes() {
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('kanban', JSON.stringify(kanban));
            updateNoteCount();
        }

        function clearEditor() {
            document.getElementById('noteTitle').value = '';
            document.getElementById('editor').value = '';
            document.getElementById('preview').innerHTML = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('aiSuggestions').style.display = 'none';
        }

        function updateNoteCount() {
            document.getElementById('noteCount').textContent = 
                `${notes.length} ${notes.length === 1 ? 'note' : 'notes'}`;
        }

        function updateActiveNoteStyle(id) {
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active-note');
                if (item.dataset.id == id) item.classList.add('active-note');
            });
        }

        function renderNotes(filter = '', tagFilter = '') {
            const list = document.getElementById('notesList');
            const filteredNotes = notes
                .filter(note => 
                    (note.title.toLowerCase().includes(filter.toLowerCase()) || 
                     note.content.toLowerCase().includes(filter.toLowerCase())) &&
                    (tagFilter === '' || note.tags.includes(tagFilter))
                )
                .sort((a, b) => b.pinned - a.pinned || new Date(b.updated) - new Date(a.updated));
            
            list.innerHTML = filteredNotes.length ? filteredNotes.map((note, index) => `
                <div class="note-item ${note.pinned ? 'pinned' : ''}" data-id="${note.id}" onclick="selectNote(${note.id})" draggable="true" style="animation-delay: ${index * 0.1}s">
                    <span>${note.title}</span>
                    <div class="tags">${note.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>
                    <small>${new Date(note.updated).toLocaleDateString()}</small>
                </div>
            `).join('') : '<p>No notes found.</p>';
        }

        function updateAISuggestions(content) {
            const suggestions = [];
            if (content.length > 50) {
                suggestions.push(`Summary: ${content.substring(0, 30)}...`);
                if (!content.includes('**')) suggestions.push('Try **bold** for emphasis.');
                if (!content.includes('#')) suggestions.push('Use # for headings.');
            }
            const tags = content.match(/\b(project|meeting|todo)\b/gi) || [];
            if (tags.length) suggestions.push(`Suggested tags: ${tags.join(', ')}`);
            document.getElementById('aiSuggestions').style.display = suggestions.length ? 'block' : 'none';
            document.getElementById('aiSuggestions').innerHTML = suggestions.map(s => `<p>${s}</p>`).join('');
        }

        function exportNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(note.title, 10, 10);
            doc.setFontSize(12);
            doc.text(note.content, 10, 20);
            doc.save(`${note.title}.pdf`);
        }

        function shareNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            const encodedContent = encodeURIComponent(JSON.stringify(note));
            const url = `${window.location.origin}${window.location.pathname}?note=${encodedContent}`;
            navigator.clipboard.writeText(url).then(() => alert('Link copied!'));
        }

        function formatText(type) {
            const editor = document.getElementById('editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            let newText = '';
            if (type === 'bold') newText = `**${selectedText}**`;
            if (type === 'italic') newText = `*${selectedText}*`;
            if (type === 'list') newText = `- ${selectedText}`;
            if (type === 'heading') newText = `# ${selectedText}`;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            updatePreview();
            addToHistory(currentNoteId);
        }

        function recordAudio() {
            if (!navigator.mediaDevices) {
                alert('Audio recording not supported.');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                const recorder = new MediaRecorder(stream);
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        document.getElementById('editor').value += `![Audio](${reader.result})`;
                        updatePreview();
                        addToHistory(currentNoteId);
                    };
                    reader.readAsDataURL(blob);
                };
                recorder.start();
                setTimeout(() => recorder.stop(), 5000);
            });
        }

        function showTemplates() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Choose a Template</h2>
                    <button class="btn" onclick="createNewNote('# Meeting Notes\\n- Agenda\\n- Decisions')">Meeting</button>
                    <button class="btn" onclick="createNewNote('- [ ] Task 1\\n- [ ] Task 2')">To-Do</button>
                    <button class="btn" onclick="createNewNote('## Journal Entry\\n- Thoughts\\n- Goals')">Journal</button>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showKanban() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Kanban Board</h2>
                    <div class="kanban-board">
                        <div class="kanban-column" id="todo"><h3>To-Do</h3></div>
                        <div class="kanban-column" id="inProgress"><h3>In Progress</h3></div>
                        <div class="kanban-column" id="done"><h3>Done</h3></div>
                    </div>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            ['todo', 'inProgress', 'done'].forEach(status => {
                const column = document.getElementById(status);
                column.innerHTML += kanban[status].map(id => {
                    const note = notes.find(n => n.id === id);
                    return note ? `<div class="note-item" data-id="${note.id}" draggable="true">${note.title}</div>` : '';
                }).join('');
                column.addEventListener('dragover', e => e.preventDefault());
                column.addEventListener('drop', e => {
                    const id = e.dataTransfer.getData('text/plain');
                    for (let s in kanban) kanban[s] = kanban[s].filter(i => i != id);
                    kanban[status].push(Number(id));
                    saveNotes();
                    showKanban();
                });
            });
        }

        function showVersionHistory() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Version History</h2>
                    <ul>
                        ${note.versions.map(v => `
                            <li>
                                ${new Date(v.timestamp).toLocaleString()}
                                <button class="btn" onclick="restoreVersion(${note.id}, '${v.timestamp}')">Restore</button>
                            </li>
                        `).join('')}
                    </ul>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function restoreVersion(id, timestamp) {
            const note = notes.find(n => n.id === id);
            const version = note.versions.find(v => v.timestamp === timestamp);
            note.title = version.title;
            note.content = version.content;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('editor').value = note.content;
            updatePreview();
            saveNotes();
            document.querySelector('.modal').remove();
        }

        function presentNote() {
            if (!currentNoteId) return;
            const note = notes.find(n => n.id === currentNoteId);
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="width: 80vw; height: 80vh;">
                    <h2>${note.title}</h2>
                    <div style="font-size: 1.5rem;">${marked.parse(note.content)}</div>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showProfile() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Your Profile</h2>
                    <p>Badges: ${badges.join(', ') || 'None'}</p>
                    <button class="btn" onclick="showSettings()">Settings</button>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showSettings() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>Settings</h2>
                    <label>Custom Shortcut (Save): <input id="customSave" type="text"></label>
                    <button class="btn" onclick="saveSettings()">Save</button>
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSettings() {
            const shortcut = document.getElementById('customSave').value;
            localStorage.setItem('customSave', shortcut);
            alert('Settings saved!');
        }

        function checkBadges() {
            if (notes.length >= 10 && !badges.includes('Note Master')) {
                badges.push('Note Master');
                alert('Badge earned: Note Master!');
            }
            const totalWords = notes.reduce((sum, n) => sum + n.content.split(/\s+/).length, 0);
            if (totalWords >= 1000 && !badges.includes('Word Wizard')) {
                badges.push('Word Wizard');
                alert('Badge earned: Word Wizard!');
            }
            localStorage.setItem('badges', JSON.stringify(badges));
        }

        function addToHistory(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            history = history.slice(0, historyIndex + 1);
            history.push({
                id,
                title: note.title,
                content: note.content,
                tags: [...note.tags]
            });
            historyIndex++;
        }

        function undo() {
            if (historyIndex <= 0) return;
            historyIndex--;
            const state = history[historyIndex];
            const note = notes.find(n => n.id === state.id);
            note.title = state.title;
            note.content = state.content;
            note.tags = state.tags;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('editor').value = note.content;
            document.getElementById('noteTags').value = note.tags.join(', ');
            updatePreview();
            saveNotes();
        }

        function redo() {
            if (historyIndex >= history.length - 1) return;
            historyIndex++;
            const state = history[historyIndex];
            const note = notes.find(n => n.id === state.id);
            note.title = state.title;
            note.content = state.content;
            note.tags = state.tags;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('editor').value = note.content;
            document.getElementById('noteTags').value = note.tags.join(', ');
            updatePreview();
            saveNotes();
        }

        function initWebSocket() {
            socket = {
                send: (data) => console.log('Collab update:', data),
                onmessage: (e) => {
                    const data = JSON.parse(e.data);
                    if (data.id === currentNoteId) {
                        document.getElementById('editor').value = data.content;
                        updatePreview();
                    }
                }
            };
            document.getElementById('collaborators').textContent = 'Collaborators: 1';
        }

        document.getElementById('editor').addEventListener('input', () => {
            updatePreview();
            addToHistory(currentNoteId);
        });

        document.getElementById('noteTitle').addEventListener('input', () => addToHistory(currentNoteId));
        document.getElementById('noteTags').addEventListener('input', () => addToHistory(currentNoteId));

        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderNotes(e.target.value, document.getElementById('tagFilter').value);
        });

        document.getElementById('tagFilter').addEventListener('input', (e) => {
            renderNotes(document.getElementById('searchInput').value, e.target.value);
        });

        document.getElementById('notesList').addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('note-item')) {
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
            }
        });

        document.getElementById('notesList').addEventListener('dragover', (e) => e.preventDefault());

        document.getElementById('notesList').addEventListener('drop', (e) => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const note = notes.find(n => n.id == id);
            note.kanbanStatus = 'todo';
            saveNotes();
            renderNotes();
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'n': e.preventDefault(); createNewNote(); break;
                    case 's': e.preventDefault(); saveNote(); break;
                    case 'd': e.preventDefault(); deleteNote(); break;
                    case 'z': e.preventDefault(); undo(); break;
                    case 'y': e.preventDefault(); redo(); break;
                    case 'p': e.preventDefault(); pinNote(); break;
                }
            }
        });

        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchmove', handleTouchMove, false);

        let xDown = null;
        function handleTouchStart(evt) {
            xDown = evt.touches[0].clientX;
        }

        function handleTouchMove(evt) {
            if (!xDown) return;
            const xUp = evt.touches[0].clientX;
            const xDiff = xDown - xUp;
            if (xDiff > 50) {
                const noteItem = evt.target.closest('.note-item');
                if (noteItem) deleteNote(Number(noteItem.dataset.id));
            }
            xDown = null;
        }

        function init() {
            if (!localStorage.getItem('visited')) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2>Welcome to Nexus Notes!</h2>
                        <p>Create, collaborate, and conquer your ideas.</p>
                        <button class="btn" onclick="this.parentElement.parentElement.remove(); localStorage.setItem('visited', 'true')">Start</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            renderNotes();
            updateNoteCount();
            if (notes.length) selectNote(notes[0].id);
            initWebSocket();
            kanban = JSON.parse(localStorage.getItem('kanban') || '{"todo":[],"inProgress":[],"done":[]}');
        }

        init();
    </script>
</body>
</html>